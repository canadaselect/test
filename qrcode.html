<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>URL 转二维码 + 中间 Logo</title>
    <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; padding: 18px; background:#f7f7fb; }
    .wrap { max-width: 980px; margin: 0 auto; display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 920px){ .wrap{ grid-template-columns: 380px 1fr; } }
    .card { background:#fff; border-radius: 14px; padding: 14px; box-shadow: 0 6px 20px rgba(0,0,0,.06); }
    label { font-size: 13px; color:#333; display:block; margin: 10px 0 6px; }
    input, select, button { width:100%; padding:10px 12px; border-radius: 10px; border:1px solid #e6e6ee; font-size: 14px; }
    input[type="range"]{ padding: 0; }
    .row { display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    .btns { display:grid; gap:10px; grid-template-columns: 1fr 1fr; margin-top: 12px; }
    button { cursor:pointer; border:none; background:#111; color:#fff; font-weight:600; }
    button.secondary { background:#fff; color:#111; border:1px solid #e6e6ee; }
    button.pure { background:#0066cc; }
    #qrBox { display:flex; align-items:center; justify-content:center; min-height: 420px; }
    .hint { color:#666; font-size: 12px; line-height: 1.5; margin-top: 10px; }
    .small { font-size:12px; color:#666; }
  </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h2 style="margin:0 0 8px;">URL → 二维码（中间 Logo）</h2>
        <div class="small">离线可用（首次加载需要网络拉库；想完全离线见文末）</div>

        <label>产品名称（会自动生成URL）</label>
        <input id="productName" placeholder="例如：皇家礼豹" value />

        <label>完整URL（自动生成）</label>
        <input id="url" placeholder="https://canadiannaturals.ca/皇家礼豹.html"
          value="https://canadiannaturals.ca/" readonly
          style="background:#f5f5f5;color:#666;" />

        <div class="row">
          <div>
            <label>尺寸（px）</label>
            <input id="size" type="number" min="160" max="1400" value="420" />
          </div>
          <div>
            <label>容错等级（越高越能遮 Logo）</label>
            <select id="ecLevel">
              <option value="L">L（7%）</option>
              <option value="M">M（15%）</option>
              <option value="Q">Q（25%）</option>
              <option value="H" selected>H（30%）</option>
            </select>
          </div>
        </div>

        <label>上传 Logo（PNG/SVG/JPG）</label>
        <input id="logo" type="file" accept="image/*" />

        <label>Logo 占比（建议 18%–26%）</label>
        <input id="logoSize" type="range" min="10" max="34" value="22" />
        <div class="small">当前：<span id="logoSizeText">22%</span></div>

        <label>Logo 白底保护边（避免干扰二维码点）</label>
        <input id="hideBgDots" type="range" min="0" max="14" value="6" />
        <div class="small">当前：<span id="hideBgDotsText">6px</span></div>

        <label>外边距（静区 quiet zone）</label>
        <input id="margin" type="number" min="0" max="40" value="12" />

        <div class="btns">
          <button id="downloadPng">下载 PNG（带文字）</button>
          <button id="downloadSvg" class="secondary">下载 SVG</button>
        </div>
        <div style="margin-top: 8px;">
          <button id="downloadQrOnly" class="pure">下载纯二维码（正方形）</button>
        </div>

        <div class="hint">
          <b>使用说明：</b><br>
          1. 输入产品名（如"皇家礼豹"），系统会自动生成完整URL<br>
          2. 容错选 <b>H</b>，Logo 占比别超过 <b>25%</b><br>
          3. Logo 周围留白（保护边）能明显提高扫码成功率<br>
          <b>点击"下载纯二维码"会同时下载两张图片：</b>一张带标题和标语，一张纯二维码。
        </div>
      </div>

      <div class="card">
        <div id="qrBox"></div>
      </div>
    </div>

    <!-- 方案A：qr-code-styling（支持中间logo & 下载PNG/SVG） -->
    <script
      src="https://unpkg.com/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>

    <script>
    const $ = (id) => document.getElementById(id);

    const qrBox = $("qrBox");

    let logoDataUrl = ""; // 存储上传的logo
    const qr = new QRCodeStyling({
      width: Number($("size").value),
      height: Number($("size").value),
      type: "svg",
      data: $("url").value.trim(),
      margin: Number($("margin").value),
      qrOptions: {
        errorCorrectionLevel: $("ecLevel").value,
      },
      dotsOptions: {
        type: "rounded",
      },
      cornersSquareOptions: {
        type: "extra-rounded",
      },
      cornersDotOptions: {
        type: "dot",
      },
      backgroundOptions: {
        color: "#ffffff",
      },
      imageOptions: {
        crossOrigin: "anonymous",
        margin: Number($("hideBgDots").value), // logo周围留白
        hideBackgroundDots: true,
      },
    });

    qr.append(qrBox);

    function updateTexts(){
      $("logoSizeText").textContent = $("logoSize").value + "%";
      $("hideBgDotsText").textContent = $("hideBgDots").value + "px";
    }

    function updateQR(){
      updateTexts();

      const size = Number($("size").value);
      const margin = Number($("margin").value);
      const logoPercent = Number($("logoSize").value);

      // 计算 logo 的宽高（按比例）
      const logoW = Math.round(size * (logoPercent / 100));
      const logoH = logoW;

      qr.update({
        width: size,
        height: size,
        data: $("url").value.trim(),
        margin,
        qrOptions: {
          errorCorrectionLevel: $("ecLevel").value,
        },
        image: logoDataUrl || undefined,
        imageOptions: {
          crossOrigin: "anonymous",
          margin: Number($("hideBgDots").value),
          hideBackgroundDots: true,
          imageSize: 1, // 让库按传入logo尺寸显示
        }
      });

      // qr-code-styling 的 imageSize 是比例参数，部分版本不精确
      // 这里用一个小技巧：通过 DOM 缩放 logo（稳定）
      setTimeout(() => {
        const img = qrBox.querySelector("image"); // SVG 内的 <image>
        if (img) {
          // 将 logo 居中并按我们计算尺寸设置
          img.setAttribute("width", String(logoW));
          img.setAttribute("height", String(logoH));
          img.setAttribute("x", String((size - logoW) / 2));
          img.setAttribute("y", String((size - logoH) / 2));
          img.setAttribute("preserveAspectRatio", "xMidYMid meet");
        }
      }, 30);
    }

    // 产品名转URL的函数
    function productNameToUrl(productName) {
      if (!productName || !productName.trim()) {
        return "https://canadiannaturals.ca/";
      }
      const name = productName.trim();
      // URL encode 中文
      const encoded = encodeURIComponent(name);
      return `https://canadiannaturals.ca/${encoded}.html`;
    }

    // 监听产品名输入，自动更新URL
    $("productName").addEventListener("input", () => {
      const productName = $("productName").value;
      const fullUrl = productNameToUrl(productName);
      $("url").value = fullUrl;
      updateQR();
    });

    // 监听输入变化
    ["url","size","ecLevel","logoSize","hideBgDots","margin"].forEach(id => {
      $(id).addEventListener("input", updateQR);
      $(id).addEventListener("change", updateQR);
    });

    // 处理 logo 上传
    $("logo").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        logoDataUrl = reader.result; // base64 dataUrl
        updateQR();
      };
      reader.readAsDataURL(file);
    });

    updateQR();

function getProductNameFromUrl(url) {
  try {
    const u = new URL(url);
    // 1) 优先识别 .html 文件名：/超级肝王.html 或 /%E8%B6%85%E7%BA%A7%E8%82%9D%E7%8E%8B.html
    const path = u.pathname || "";
    const last = path.split("/").filter(Boolean).pop() || "";
    
    if (last.endsWith(".html")) {
      // 解码URL编码的中文
      const decoded = decodeURIComponent(last);
      return decoded.replace(/\.html$/i, "");
    }

    // 2) 其次识别 query：?product=超级肝王 或 ?name=xxx
    const p = u.searchParams.get("product") || u.searchParams.get("name") || "";
    if (p) return decodeURIComponent(p);

    // 3) 再其次：如果路径最后一段就是中文产品名
    if (last) return decodeURIComponent(last);
  } catch (e) {
    // 如果不是标准 URL（比如用户输入少了 https），兜底用字符串方式
    const s = String(url || "");
    const m = s.match(/([^\/?#]+)\.html/i);
    if (m && m[1]) {
      try {
        return decodeURIComponent(m[1]);
      } catch(e2) {
        return m[1];
      }
    }
  }
  return ""; // 识别不到就返回空
}

function wrapText(ctx, text, maxWidth) {
  const words = text.split(""); // 中文按字切
  const lines = [];
  let line = "";
  for (const ch of words) {
    const test = line + ch;
    if (ctx.measureText(test).width > maxWidth && line) {
      lines.push(line);
      line = ch;
    } else {
      line = test;
    }
  }
  if (line) lines.push(line);
  return lines;
}

// 下载带文字的二维码
$("downloadPng").addEventListener("click", async () => {
  // 1) 先从库里拿到二维码 PNG
  const blob = await qr.getRawData("png");
  const url = URL.createObjectURL(blob);

  const img = new Image();
  img.onload = () => {
    // 2) 计算画布尺寸（上面加标题，下面加slogan）
    const qrSize = Number($("size").value); // 你输入的二维码尺寸
    const dpr = window.devicePixelRatio || 1;

    const slogan = "花大钱给医生还是花小钱来养生？";

    const product = getProductNameFromUrl($("url").value.trim());
    const header = product ? `加国甄选｜${product}` : "加国甄选｜二维码";

    // 文字区高度（跟二维码尺寸成比例）
    const topPad = Math.round(qrSize * 0.16);
    const bottomPad = Math.round(qrSize * 0.20);
    const sidePad = Math.round(qrSize * 0.08);

    // 画布
    const canvas = document.createElement("canvas");
    canvas.width = Math.round(qrSize * dpr);
    canvas.height = Math.round((qrSize + topPad + bottomPad) * dpr);

    const ctx = canvas.getContext("2d");
    ctx.scale(dpr, dpr);

    // 背景白底
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, qrSize, qrSize + topPad + bottomPad);

    // 3) 画标题
    ctx.fillStyle = "#111";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.font = `700 ${Math.round(qrSize * 0.06)}px system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif`;
    ctx.fillText(header, qrSize / 2, topPad / 2);

    // 4) 画二维码（居中）
    const qrY = topPad;
    ctx.drawImage(img, 0, qrY, qrSize, qrSize);

    // 5) 画 slogan（自动换行，居中）
    const sloganYStart = topPad + qrSize + bottomPad * 0.40;
    ctx.font = `600 ${Math.round(qrSize * 0.05)}px system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif`;
    ctx.fillStyle = "#111";

    const maxTextWidth = qrSize - sidePad * 2;
    const lines = wrapText(ctx, slogan, maxTextWidth);
    const lineHeight = Math.round(qrSize * 0.065);

    // 让多行整体垂直居中在底部区域
    const totalH = lines.length * lineHeight;
    let y = sloganYStart - totalH / 2;

    for (const line of lines) {
      ctx.fillText(line, qrSize / 2, y);
      y += lineHeight;
    }

    // 6) 下载
    canvas.toBlob((outBlob) => {
      const a = document.createElement("a");
      const outUrl = URL.createObjectURL(outBlob);

      // 文件名也带上产品名
      const safeName = (product || "qr").replace(/[\\/:*?"<>|]/g, "_");
      a.download = `${safeName}二维码.png`;
      a.href = outUrl;
      a.click();

      URL.revokeObjectURL(outUrl);
    }, "image/png");

    // 清理
    URL.revokeObjectURL(url);
  };

  img.src = url;
});

// 下载纯二维码（先正方形，再带文字）— WebP
$("downloadQrOnly").addEventListener("click", async () => {
  const qrSize = Number($("size").value);
  const product = getProductNameFromUrl($("url").value.trim());
  const safeName = (product || "qr").replace(/[\\/:*?"<>|]/g, "_");

  // 从库里拿二维码 PNG（作为绘制源）
  const blob = await qr.getRawData("png");
  const url = URL.createObjectURL(blob);

  const img = new Image();
  img.onload = () => {
    const dpr = window.devicePixelRatio || 1;

    const slogan = "花大钱给医生还是花小钱来养生？";
    const header = product ? `加国甄选｜${product}` : "加国甄选｜二维码";

    const topPad = Math.round(qrSize * 0.16);
    const bottomPad = Math.round(qrSize * 0.20);
    const sidePad = Math.round(qrSize * 0.08);

    // ===== canvas1：带标题+标语（竖图）=====
    const canvas1 = document.createElement("canvas");
    canvas1.width = Math.round(qrSize * dpr);
    canvas1.height = Math.round((qrSize + topPad + bottomPad) * dpr);
    const ctx1 = canvas1.getContext("2d");
    ctx1.scale(dpr, dpr);

    ctx1.fillStyle = "#ffffff";
    ctx1.fillRect(0, 0, qrSize, qrSize + topPad + bottomPad);

    ctx1.fillStyle = "#111";
    ctx1.textAlign = "center";
    ctx1.textBaseline = "middle";
    ctx1.font = `700 ${Math.round(qrSize * 0.06)}px system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif`;
    ctx1.fillText(header, qrSize / 2, topPad / 2);

    ctx1.drawImage(img, 0, topPad, qrSize, qrSize);

    const sloganYStart = topPad + qrSize + bottomPad * 0.40;
    ctx1.font = `600 ${Math.round(qrSize * 0.05)}px system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif`;
    const maxTextWidth = qrSize - sidePad * 2;
    const lines = wrapText(ctx1, slogan, maxTextWidth);
    const lineHeight = Math.round(qrSize * 0.065);
    const totalH = lines.length * lineHeight;
    let y = sloganYStart - totalH / 2;
    for (const line of lines) {
      ctx1.fillText(line, qrSize / 2, y);
      y += lineHeight;
    }

    // ===== canvas2：纯二维码（正方形）=====
    const canvas2 = document.createElement("canvas");
    canvas2.width = Math.round(qrSize * dpr);
    canvas2.height = Math.round(qrSize * dpr);
    const ctx2 = canvas2.getContext("2d");
    ctx2.scale(dpr, dpr);

    ctx2.fillStyle = "#ffffff";
    ctx2.fillRect(0, 0, qrSize, qrSize);
    ctx2.drawImage(img, 0, 0, qrSize, qrSize);

    const downloadBlob = (b, filename) => {
      const a = document.createElement("a");
      const u = URL.createObjectURL(b);
      a.download = filename;
      a.href = u;
      a.click();
      URL.revokeObjectURL(u);
    };

    // ===== 先下载正方形 =====
    canvas2.toBlob((blob2) => {
      downloadBlob(blob2, `${safeName}qr.webp`);

      // 再下载带文字（稍微延迟避免浏览器拦截多下载）
      setTimeout(() => {
        canvas1.toBlob((blob1) => {
          downloadBlob(blob1, `${safeName}qr_text.webp`);
        }, "image/webp", 0.92);
      }, 120);
    }, "image/webp", 0.92);

    URL.revokeObjectURL(url);
  };

  img.src = url;
});

  </script>
  </body>
</html>
